@page "/bedienung"
@rendermode InteractiveServer
@layout ArgeKassenbuch.Components.Layout.EmptyLayout
@inject KassenbuchService Db
@attribute [Authorize(Roles = "Admin,Kassenwart,Bedienung")]
@inject NavigationManager Nav

<PageTitle>Bedienungs-Modus - ArGe Kassenbuch</PageTitle>

<style>
    .bed-page { min-height: 100vh; background: #f0f2f5; }

    .bed-bar {
        background: #1a1a2e; color: white; padding: 0.5rem 1rem;
        display: flex; justify-content: space-between; align-items: center;
        position: sticky; top: 0; z-index: 100;
    }
    .bed-bar-info { font-size: 0.85rem; opacity: 0.8; }

    .bed-section { padding: 0.75rem 1rem; }
    .bed-section-title { font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: #6c757d; margin-bottom: 0.5rem; }

    .bed-person-btn {
        display: inline-flex; align-items: center; gap: 0.5rem;
        padding: 0.6rem 1.2rem; border-radius: 2rem;
        border: 2px solid #dee2e6; background: white; cursor: pointer;
        font-weight: 600; font-size: 0.95rem; transition: all 0.15s;
        white-space: nowrap;
    }
    .bed-person-btn:hover { border-color: #4361ee; }
    .bed-person-btn.active { background: #4361ee; color: white; border-color: #4361ee; }

    .bed-stand-header {
        font-weight: 700; font-size: 0.85rem; color: #495057;
        background: #e9ecef; border-radius: 0.5rem;
        padding: 0.4rem 0.75rem; margin-bottom: 0.5rem; margin-top: 0.75rem;
        display: flex; align-items: center; gap: 0.4rem;
    }
    .bed-stand-header:first-child { margin-top: 0; }

    .bed-ware-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }

    .bed-ware-card {
        background: white; border: 2px solid #e9ecef; border-radius: 0.75rem;
        padding: 1rem; text-align: center; cursor: pointer;
        transition: all 0.12s; user-select: none; position: relative;
    }
    .bed-ware-card:hover { border-color: #4361ee; background: #f8f9ff; }
    .bed-ware-card:active { transform: scale(0.96); }
    .bed-ware-card.hat-anzahl { border-color: #4361ee; background: #eef1ff; }
    .bed-ware-card .ware-name { font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem; }
    .bed-ware-card .ware-preis { color: #4361ee; font-weight: 700; font-size: 1.1rem; }
    .bed-ware-card .ware-anzahl {
        position: absolute; top: -0.6rem; right: -0.6rem;
        background: #ef476f; color: white; font-weight: 700;
        width: 2rem; height: 2rem; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-size: 1rem;
    }
    .bed-ware-card .ware-minus {
        position: absolute; top: -0.4rem; left: -0.4rem;
        background: white; border: 2px solid #ef476f; color: #ef476f;
        width: 1.75rem; height: 1.75rem; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; font-weight: 700; cursor: pointer; line-height: 1;
    }
    .bed-ware-card .ware-minus:hover { background: #ef476f; color: white; }

    .bed-bon { background: white; border-radius: 0.75rem; margin: 0 1rem 1rem; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .bed-bon-header { background: #1a1a2e; color: white; padding: 0.75rem 1rem; font-weight: 700; display: flex; justify-content: space-between; }
    .bed-bon-row { display: flex; justify-content: space-between; padding: 0.5rem 1rem; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; }
    .bed-bon-row:last-child { border-bottom: none; }
    .bed-bon-footer { padding: 1rem; border-top: 2px solid #e9ecef; }
    .bed-bon-total { font-size: 1.75rem; font-weight: 800; }

    .bed-toast {
        position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
        background: #06d6a0; color: white; padding: 0.75rem 2rem;
        border-radius: 2rem; font-weight: 700; font-size: 1.1rem; z-index: 9999;
        box-shadow: 0 4px 20px rgba(6,214,160,0.4);
    }

    @@media (max-width: 600px) {
        .bed-bar { padding: 0.4rem 0.75rem; font-size: 0.85rem; }
        .bed-bar-info { font-size: 0.75rem; }
        .bed-section { padding: 0.5rem 0.5rem; }
        .bed-section-title { font-size: 0.7rem; margin-bottom: 0.35rem; }
        .bed-person-btn { padding: 0.45rem 0.8rem; font-size: 0.8rem; gap: 0.3rem; }
        .bed-ware-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; }
        .bed-ware-card { padding: 0.6rem 0.4rem; border-radius: 0.5rem; }
        .bed-ware-card .ware-name { font-size: 0.8rem; }
        .bed-ware-card .ware-preis { font-size: 0.85rem; }
        .bed-ware-card .ware-anzahl { width: 1.5rem; height: 1.5rem; font-size: 0.8rem; top: -0.4rem; right: -0.4rem; }
        .bed-ware-card .ware-minus { width: 1.4rem; height: 1.4rem; font-size: 1rem; top: -0.3rem; left: -0.3rem; }
        .bed-bon { margin: 0 0.5rem 0.5rem; }
        .bed-bon-header { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
        .bed-bon-row { padding: 0.4rem 0.75rem; font-size: 0.8rem; }
        .bed-bon-footer { padding: 0.75rem; }
        .bed-bon-total { font-size: 1.3rem; }
        .bed-stand-header { font-size: 0.75rem; padding: 0.3rem 0.5rem; }
        .bed-toast { font-size: 0.9rem; padding: 0.6rem 1.2rem; bottom: 1rem; }
    }
</style>

<div class="bed-page">

@if (_aktiveVeranstaltung == null)
{
    <div style="max-width:500px;margin:0 auto;padding:3rem 1rem;text-align:center;">
        <i class="bi bi-exclamation-triangle" style="font-size:3rem;color:#ffc107;"></i>
        <h3 class="fw-bold mt-2">Keine aktive Veranstaltung</h3>
        <p class="text-muted">Bitte zuerst unter Veranstaltungen eine aktivieren.</p>
    </div>
}
else
{
    @* === ADMIN DIALOG === *@
    @if (_zeigeAdminDialog)
    {
        <div class="modal show d-block" tabindex="-1" style="background:rgba(0,0,0,0.7);">
            <div class="modal-dialog modal-dialog-centered" style="max-width:400px;">
                <div class="modal-content">
                    <div class="modal-header modal-header-gradient-danger">
                        <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i>Admin-Passwort</h5>
                    </div>
                    <div class="modal-body">
                        <input type="password" class="form-control form-control-lg" placeholder="Passwort eingeben"
                               @bind="_adminPasswortEingabe" @onkeyup="AdminPasswortPruefen" />
                        @if (_falschesPasswort)
                        {
                            <div class="text-danger fw-bold mt-2"><i class="bi bi-x-circle me-1"></i>Falsches Passwort!</div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-secondary" @onclick="() => { _zeigeAdminDialog = false; _adminPasswortEingabe = string.Empty; _falschesPasswort = false; }">Abbrechen</button>
                        <button class="btn btn-danger" @onclick="AdminAbmelden"><i class="bi bi-box-arrow-right me-1"></i>Abmelden</button>
                    </div>
                </div>
            </div>
        </div>
    }

    @* === TOP BAR === *@
    <div class="bed-bar">
        <div>
            <strong>@_aktiveVeranstaltung?.Name</strong>
        </div>
        <button class="btn btn-outline-light btn-sm" @onclick="() => _zeigeAdminDialog = true">
            <i class="bi bi-box-arrow-right me-1"></i>Beenden
        </button>
    </div>

    @* === 1. BEDIENUNG WAEHLEN === *@
    <div class="bed-section">
        <div class="bed-section-title">Bedienung</div>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var bed in _bedienungen)
            {
                <div class="bed-person-btn @(_selectedBedienungId == bed.Id ? "active" : "")"
                     @onclick="() => _selectedBedienungId = bed.Id">
                    <i class="bi bi-person-fill"></i>
                    @bed.VollerName
                </div>
            }
        </div>
    </div>

    @* === 2. ARTIKEL (alle Staende) === *@
    <div class="bed-section">
        <div class="bed-section-title">Artikel</div>
        @foreach (var gruppe in _warenNachStand)
        {
            <div class="bed-stand-header"><i class="bi bi-shop"></i> @gruppe.Key</div>
            <div class="bed-ware-grid">
                @foreach (var ware in gruppe.Value)
                {
                    var anzahl = _bonPositionen.FirstOrDefault(p => p.WareId == ware.Id)?.Anzahl ?? 0;
                    <div class="bed-ware-card @(anzahl > 0 ? "hat-anzahl" : "")" @onclick="() => ArtikelHinzufuegen(ware)">
                        <div class="ware-name">@ware.Name</div>
                        <div class="ware-preis">@ware.Preis.ToString("C", _culture)</div>
                        @if (anzahl > 0)
                        {
                            <div class="ware-anzahl">@anzahl</div>
                            <div class="ware-minus" @onclick="() => ArtikelEntfernen(ware)" @onclick:stopPropagation="true">
                                <i class="bi bi-dash"></i>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>

    @* === 3. BON === *@
    @if (_bonPositionen.Any())
    {
        <div class="bed-bon">
            <div class="bed-bon-header">
                <span><i class="bi bi-receipt me-2"></i>Bestellung</span>
                <span>@_bonPositionen.Sum(p => p.Anzahl) Artikel | @_anzahlBons Bon(s)</span>
            </div>
            @foreach (var standGruppe in _bonPositionenNachStand)
            {
                <div style="padding:0.4rem 1rem 0.1rem;font-size:0.75rem;font-weight:700;color:#6c757d;text-transform:uppercase;background:#f8f9fa;">@standGruppe.Key</div>
                @foreach (var pos in standGruppe.Value)
                {
                    <div class="bed-bon-row">
                        <span><strong>@pos.Anzahl x</strong> @pos.WareName</span>
                        <span class="fw-bold">@pos.Gesamtpreis.ToString("C", _culture)</span>
                    </div>
                }
            }
            <div class="bed-bon-footer">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="fw-bold text-muted">Gesamt (@_anzahlBons Bon@(_anzahlBons != 1 ? "s" : ""))</span>
                    <span class="bed-bon-total">@_bonGesamt.ToString("C", _culture)</span>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary flex-shrink-0" @onclick="BonVerwerfen">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <button class="btn btn-success btn-lg flex-grow-1" @onclick="BonsErstellen"
                            disabled="@(_selectedBedienungId == 0)">
                        <i class="bi bi-check-circle me-2"></i>Bestellung abschliessen
                    </button>
                </div>
                @if (_selectedBedienungId == 0)
                {
                    <div class="text-danger small mt-2"><i class="bi bi-exclamation-triangle me-1"></i>Bitte oben eine Bedienung waehlen</div>
                }
            </div>
        </div>
    }
}

</div>

@if (!string.IsNullOrEmpty(_meldung))
{
    <div class="bed-toast">
        <i class="bi bi-check-circle me-2"></i>@_meldung
    </div>
}

@code {
    private static readonly System.Globalization.CultureInfo _culture = new("de-DE");
    private bool _zeigeAdminDialog;
    private string _adminPasswortEingabe = string.Empty;
    private bool _falschesPasswort;
    private int _selectedBedienungId;

    private Veranstaltung? _aktiveVeranstaltung;
    private List<Bedienung> _bedienungen = new();
    private List<Verkaufsstand> _staende = new();
    private List<Ware> _alleWaren = new();
    private Dictionary<string, List<Ware>> _warenNachStand = new();
    private List<BonPosition> _bonPositionen = new();
    private int _naechsteBonNr = 1;
    private decimal _bonGesamt => _bonPositionen.Sum(p => p.Gesamtpreis);
    private int _anzahlBons => _bonPositionenNachStand.Count;
    private Dictionary<string, List<BonPosition>> _bonPositionenNachStand =>
        _bonPositionen.GroupBy(p => _standNameFuerWare(p.WareId)).ToDictionary(g => g.Key, g => g.ToList());
    private string? _meldung;
    private AppEinstellungen? _einstellungen;

    private string _standNameFuerWare(int wareId)
    {
        var ware = _alleWaren.FirstOrDefault(w => w.Id == wareId);
        if (ware?.VerkaufsstandId != null)
        {
            var stand = _staende.FirstOrDefault(s => s.Id == ware.VerkaufsstandId);
            return stand?.Name ?? "Sonstige";
        }
        return "Sonstige";
    }

    private int? _standIdFuerWare(int wareId)
    {
        return _alleWaren.FirstOrDefault(w => w.Id == wareId)?.VerkaufsstandId;
    }

    protected override async Task OnInitializedAsync()
    {
        _einstellungen = await Db.GetEinstellungenAsync();
        if (_einstellungen.AktiveVeranstaltungId.HasValue)
            _aktiveVeranstaltung = await Db.GetVeranstaltungAsync(_einstellungen.AktiveVeranstaltungId.Value);
        _bedienungen = (await Db.GetBedienungenAsync()).Where(b => b.Aktiv).ToList();
        _staende = (await Db.GetVerkaufsstaendeAsync()).Where(s => s.Aktiv).ToList();
        _alleWaren = (await Db.GetWarenAsync()).Where(w => w.Aktiv).ToList();

        _warenNachStand = _alleWaren
            .GroupBy(w => _staende.FirstOrDefault(s => s.Id == w.VerkaufsstandId)?.Name ?? "Sonstige")
            .ToDictionary(g => g.Key, g => g.ToList());

        if (_aktiveVeranstaltung != null)
            _naechsteBonNr = await Db.GetNaechsteBonNummerAsync(_aktiveVeranstaltung.Id);
    }

    private void ArtikelHinzufuegen(Ware ware)
    {
        var existing = _bonPositionen.FirstOrDefault(p => p.WareId == ware.Id);
        if (existing != null)
            existing.Anzahl++;
        else
            _bonPositionen.Add(new BonPosition
            {
                WareId = ware.Id,
                WareName = ware.Name,
                Anzahl = 1,
                Einzelpreis = ware.Preis
            });
    }

    private void ArtikelEntfernen(Ware ware)
    {
        var existing = _bonPositionen.FirstOrDefault(p => p.WareId == ware.Id);
        if (existing != null)
        {
            existing.Anzahl--;
            if (existing.Anzahl <= 0)
                _bonPositionen.Remove(existing);
        }
    }

    private async Task BonsErstellen()
    {
        if (_aktiveVeranstaltung == null || !_bonPositionen.Any() || _selectedBedienungId == 0) return;

        var nachStand = _bonPositionen
            .GroupBy(p => _standIdFuerWare(p.WareId))
            .ToList();

        var erstellteBons = new List<string>();

        foreach (var gruppe in nachStand)
        {
            var bon = new Bon
            {
                VeranstaltungId = _aktiveVeranstaltung.Id,
                BedienungId = _selectedBedienungId,
                VerkaufsstandId = gruppe.Key,
                BonNummer = _naechsteBonNr,
                Positionen = gruppe.Select(p => new BonPosition
                {
                    WareId = p.WareId,
                    WareName = p.WareName,
                    Anzahl = p.Anzahl,
                    Einzelpreis = p.Einzelpreis
                }).ToList(),
                Gesamtbetrag = gruppe.Sum(p => p.Gesamtpreis),
                ErstelltAm = DateTime.Now
            };

            await Db.AddAsync(bon);
            var standName = _staende.FirstOrDefault(s => s.Id == gruppe.Key)?.Name ?? "?";
            erstellteBons.Add($"#{bon.BonNummer} {standName}");
            _naechsteBonNr++;
        }

        _bonPositionen.Clear();
        _meldung = $"{erstellteBons.Count} Bon(s): {string.Join(", ", erstellteBons)}";
        StateHasChanged();
        _ = ClearMeldung();
    }

    private void BonVerwerfen() => _bonPositionen.Clear();

    private async Task AdminAbmelden()
    {
        if (_einstellungen != null && _adminPasswortEingabe == _einstellungen.AdminPasswort)
        {
            Nav.NavigateTo("/", forceLoad: true);
        }
        else
        {
            _falschesPasswort = true;
        }
        await Task.CompletedTask;
    }

    private async Task AdminPasswortPruefen(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await AdminAbmelden();
    }

    private async Task ClearMeldung()
    {
        await Task.Delay(3000);
        _meldung = null;
        await InvokeAsync(StateHasChanged);
    }
}
